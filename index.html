<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Cubbyhole web client</title>
        <link rel="stylesheet" href="/app/bower_components/foundation/css/foundation.min.css">
        <link rel="stylesheet" href="/app/css/style.css">
    </head>

    <body>
    	<div id="main"></div>

    	<script src="/app/bower_components/jquery/dist/jquery.min.js"></script>
    	<script src="/app/bower_components/foundation/js/foundation.min.js"></script>

        <script src="http://fb.me/react-0.9.0.js"></script>
	    <script src="http://fb.me/JSXTransformer-0.9.0.js"></script>

	    <script src="/app/bower_components/reqwest/reqwest.min.js"></script>
		<script src="/app/bower_components/eventEmitter/EventEmitter.min.js"></script>

		<script src="/app/js/fileManager.js"></script>
		<script src="/app/js/accountManager.js"></script>
		<script>
			var view = null;
			var req = (function($http, authBase64) {
			    return function(config) {
			        if (typeof config !== 'object')
			            config = {}

			        config.headers = config.headers || {};
			        config.headers.Authorization = authBase64;
			        config.type = 'json';
			        res = $http(config);
			        res.catch = res.fail;
			        return res;
			    }
			})(reqwest, 'Basic dXNlcjpwYXNz');

			var store = {}
			store.files = []
			store.currentFile = null;
			store.shares = [];
			store.accounts = {};
			store.shareLink = "";

			var fileManager = new FileManager('http://37.187.46.33/api/v1', req);
			var accountManager = new AccountManager('http://37.187.46.33/api/v1', req);


			fileManager.list().then(function (files) {
				return files.map(function (file) {
					file.cdate = new Date(file.cdate);
					return file;
				})
			}).then(function (files) {
				store.files = files;
				view.forceUpdate();
			})

			var dispatcher = new EventEmitter();

			dispatcher.on('ch.file.create', function (opts) {
				if (opts.isFolder) {
					fileManager.add(
						opts.isFolder, 
						opts.name, store.currentFile ? store.currentFile.id : 0
					).then(function (file) {
						store.files.push(file);
						view.forceUpdate();
					}).catch(function (error) {
						console.error(error);
					})
				}
			})

			dispatcher.on('ch.file.delete', function (file) {
				fileManager.delete(file.id).then(function (response) {
					store.files.splice(store.files.indexOf(file), 1);
					view.forceUpdate();
				}).catch(function (error) {
					console.error(error);
				})
			})

			dispatcher.on('ch.file.copy', function (file) {
				fileManager.copy(file).then(function (file) {
					store.files.push(file)
					view.forceUpdate();
				}).catch(function (error) {
					console.error(error);
				})
			})

			dispatcher.on('ch.file.openFolder', function (file) {
				fileManager.list(file.id).then(function (files) {
					store.showShares = false;
					store.currentFile = file;
					store.files = files;
					view.forceUpdate();
				}).catch(function (error) {
					console.error(error);
				})
			})

			dispatcher.on('ch.file.openParent', function (currentFile) {
				if (store.currentFile) {
					fileManager.getFileById(store.currentFile.parent).then(function (file) {
						dispatcher.trigger('ch.file.openFolder', [file]);
					})
				}
			})	

			dispatcher.on('ch.file.share', function (opts) {
				fileManager.share(
					opts.fileId, 
					opts.accountId, 
					opts.permission
				).then(function (share) {
					store.shares.push(share)
				}).catch(function (error) {
					console.error(error);
				});
			})

			dispatcher.on('ch.file.getShares', function (file) {
				fileManager.getShares(file.id).then(function (shares) {
					if (shares.length > 0) {
						for (var i = 0; i < shares.length; i++) {
							accountManager.getAccountById(shares[i].account)
								.then(function (account) {
									store.shares = shares;
									store.accounts[account.id] = account;
									store.showShares = true;
									view.forceUpdate();
								});
						}
					}
				}).catch(function (error) {
					console.error(error)
				})
			})


			dispatcher.on('ch.file.generateShareLink', function (fileId) {
				fileManager.getShareLink(fileId).then(function (link) {
					store.shareLink = link;
					store.showShareLink = true;
	    			view.forceUpdate()
				})
			})

			function startAction(name, args) {
		    	return function () {
		    		console.log('CALL TO ACTION :', name)
		    		dispatcher.trigger(name, args);
		    	}
		    }

		</script>

	    <script type="text/jsx">
	    /*** @jsx React.DOM */
	    var APP = React.createClass({
	        render: function () {
	            return <MainLayout store={this.props.store} />
	        }
	    });

	    var MainLayout = React.createClass({
	    	render: function () {
	    		return <div className="mainLayout">
	    			<NavBar />
	    			<div className="row">
	    				<div className="large-3 medium-4 columns">
	    					<SideBar store={this.props.store} />
	    				</div>
	    				<div className="large-9 medium-8 columns">
	    					<Content store={this.props.store} />
	    				</div>
	    			</div>
	    		</div>
	    	}
	    });

	    var NavBar = React.createClass({
	    	render: function () {
	    		return <nav className="top-bar">
			      <ul className="title-area">
			        <li className="name">
			          <h1><a href="#">Cubbyhole</a></h1>
			        </li>
			      </ul>

			      <section className="top-bar-section">
			        <ul className="right">
			          <li>
			            <a href="#">Username</a>
			          </li>
			          <li>
			            <a href="#">
			                <i className="fi-wrench"></i>
			                <span>Settings</span>
			            </a>
			          </li>
			          <li>
			            <a href="#"><span className="alert round label">go pro !</span> Upgrade offer</a>
			          </li>
			        </ul>
			      </section>
			    </nav>
	    	}
	    });

	    var SideBar = React.createClass({
	    	render: function () {
	    		return <div className="page-sidebar">
	    			<h2>Actions</h2>
	    			<CreateFolder />
					<ShareFile store={this.props.store}/>	    			
				</div>
	    	}
	    });

	    var CreateFolder = React.createClass({
	    	render: function() {
	    		return <div>
	    			<h3>create folder</h3>
	    			<input ref="folderName" type="text" placeholder="folder name" />
	    			<button type="button"
	    				className="radius"
	    				onClick={this.createFolder}>
	    				create folder
	    			</button>
	    		</div>
	    	},
			createFolder: function () {
	    		startAction("ch.file.create", [{isFolder:true, name:this.refs.folderName.getDOMNode().value}])();
	    	}
	    })

		var ShareFile = React.createClass({
			render: function() {
				return <div>
					<h3>share file</h3>
	    			<input ref="accountId" type="text" placeholder="account id" />
	    			<select ref="file">
	    				{
	    					this.props.store.files.map(function (file) {
	    						return file.isFolder === false ? <option value={file.id}>{file.name}</option> : ""
	    					})
	    				}
	    			</select>
	    			<select ref="permission">
	    				<option value="READ">READ</option>
	    				<option value="WRITE">WRITE</option>
	    				<option value="LINK">LINK</option>
	    				<option value="PERM">PERM</option>
	    			</select>
	    			<button type="button"
	    				className="radius"
	    				onClick={this.shareFile}>
	    				share file
	    			</button>
	    		</div>
			},
			shareFile: function () {
	    		startAction("ch.file.share", [{
	    			fileId: this.refs.file.getDOMNode().value,
	    			accountId: this.refs.accountId.getDOMNode().value,
	    			permission: this.refs.permission.getDOMNode().value
	    		}])();
	    	}
		})



	    var Content = React.createClass({
	    	render: function () {
	    		return <div className="page-content">
	    			<FileViewer store={this.props.store} />
	    			{store.showShares ? <SharesViewer store={this.props.store} /> : null}
	    			{store.showShareLink ? <ShareLink store={this.props.store} /> : null}
	    		</div>
	    	}
	    });


	    var SharesViewer = React.createClass({
	    	render: function () {
	    		return <div className="panel callout radius">
	    			<span className="closePanel" onClick={this.closePanel}>×</span>
	    			<h4>Shares</h4>	
	    			{
	    				this.props.store.shares.map(function (share) {
	    					return <Share share={share} />
	    				})
	    			}
	    		</div>
	    	},
	    	closePanel : function () {
	    		store.showShares = false;
				view.forceUpdate();
	    	}
	    })


	    var Share = React.createClass({
	    	render: function () {
	    		return <div>
	    			<span>{store.accounts[this.props.share.account].username}&nbsp;</span>
	    			<span>{this.props.share.permission}&nbsp;</span>
	    		</div>
	    	}
	    })

	    var FileViewer = React.createClass({
	    	render: function () {
	    		return <div>
	    		<h2>Files</h2>
	    			{
						this.props.store.currentFile && (this.props.store.currentFile.parent !== 0) ? 
	    				<button onClick={this.getParent} className="radius">
	    					parent folder
	    				</button> : null
	    			}

	    			{
	    				this.props.store.files.map(function (file) {
	    					return <File file={file} />
	    				})
	    			}
	    		</div>
	    	},
	    	getParent: function () {
	    		startAction('ch.file.openParent')();
	    	}
	    });

	    var File = React.createClass({
	    	render: function () {
	    		return <div className="file">
	    			<span className="fileInfos" onClick={this.getShares} onDoubleClick={this.props.file.isFolder ? this.openFolder : null}>
	    				<img className="fileImage" src={this.props.file.isFolder ? "/app/assets/folder.png" : "/app/assets/file.png"} />
	    				<span>{this.props.file.name}&nbsp;</span> 
	    				<span>{this.props.file.cdate.toLocaleString()}&nbsp;</span>
	    			</span>
	    			<span className="fileActions">
		    			<span onClick={startAction("ch.file.delete", [this.props.file])}>delete&nbsp;</span>
		    			<span onClick={startAction("ch.file.copy", [this.props.file])}>copy&nbsp;</span>
		    			{this.props.file.isFolder ? null : <span onClick={this.generateShareLink}>generate share link</span>}
	    			</span>
	    		</div>
	    	},
	    	openFolder : function () {
	    		startAction('ch.file.openFolder', [this.props.file])();
	    	},
	    	getShares : function () {
	    		startAction('ch.file.getShares', [this.props.file])();
	    	},
	    	generateShareLink : function () {
	    		startAction('ch.file.generateShareLink', [this.props.file.id])();
	    	}
	    });


		var ShareLink = React.createClass({
			render: function () {
				return <div id="sharePanel" className="panel callout radius">
				<span className="closePanel" onClick={this.closePanel}>×</span>
					<h4>Public link</h4>
	    			<span>{this.props.store.shareLink}</span>
	    		</div>
			},
			closePanel : function () {
				store.showShareLink = false;
	    		view.forceUpdate()
			}
		})

	    view = React.renderComponent(<APP store={store}/>, document.getElementById('main'));
	    </script>
        <script src="/app/js/app.js"></script>
    </body>
</html>
